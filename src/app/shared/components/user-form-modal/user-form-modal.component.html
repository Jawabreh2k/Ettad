<app-modal [isOpen]="isOpen" [title]="title" (closed)="close()">
  <form [formGroup]="userForm" (ngSubmit)="onSubmit()" class="space-y-6">
    <!-- Username -->
    <div>
      <label class="block text-sm font-semibold text-[var(--color-text)] mb-2">
        Username <span class="text-[var(--color-error)]">*</span>
      </label>
      <input
        type="text"
        formControlName="userName"
        placeholder="Enter username or email"
        class="w-full px-4 py-2.5 border-2 border-[var(--color-border)] rounded-lg focus:outline-none focus:border-[var(--color-brand)] focus:ring-4 focus:ring-[var(--color-brand)]/20 transition-all"
        [class.border-[var(--color-error)]]="userForm.get('userName')?.invalid && userForm.get('userName')?.touched"
      />
      <p *ngIf="getFieldError('userName')" class="mt-2 text-sm text-[var(--color-error)]">
        {{ getFieldError('userName') }}
      </p>
    </div>

    <!-- Password (Create Mode Only) -->
    <div *ngIf="mode === 'create'">
      <label class="block text-sm font-semibold text-[var(--color-text)] mb-2">
        Password <span class="text-[var(--color-error)]">*</span>
      </label>
      <input
        type="password"
        formControlName="password"
        placeholder="Enter password"
        class="w-full px-4 py-2.5 border-2 border-[var(--color-border)] rounded-lg focus:outline-none focus:border-[var(--color-brand)] focus:ring-4 focus:ring-[var(--color-brand)]/20 transition-all"
        [class.border-[var(--color-error)]]="userForm.get('password')?.invalid && userForm.get('password')?.touched"
      />
      <p *ngIf="getFieldError('password')" class="mt-2 text-sm text-[var(--color-error)]">
        {{ getFieldError('password') }}
      </p>
    </div>

    <!-- Roles Selection -->
    <div class="relative">
      <label class="block text-sm font-semibold text-[var(--color-text)] mb-2">
        Roles <span class="text-[var(--color-error)]">*</span>
      </label>
      <div class="relative">
        <button
          type="button"
          (click)="toggleRolesDropdown()"
          class="w-full px-4 py-2.5 border-2 border-[var(--color-border)] rounded-lg focus:outline-none focus:border-[var(--color-brand)] focus:ring-4 focus:ring-[var(--color-brand)]/20 transition-all text-left flex items-center justify-between bg-white"
          [class.border-[var(--color-error)]]="selectedRoleIds.length === 0 && errorMessage.includes('role')"
        >
          <span [class.text-[var(--color-text-muted)]="selectedRoleIds.length === 0">
            {{ getSelectedRolesText() }}
          </span>
          <svg class="w-5 h-5 text-[var(--color-text-muted)] transition-transform" [class.rotate-180]="showRolesDropdown" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
          </svg>
        </button>

        <!-- Dropdown Menu -->
        <div
          *ngIf="showRolesDropdown"
          class="absolute z-50 w-full mt-2 bg-white border-2 border-[var(--color-border)] rounded-lg shadow-lg max-h-60 overflow-y-auto"
        >
          <div class="p-2">
            <div
              *ngFor="let role of roles"
              (click)="toggleRoleSelection(role.id)"
              class="flex items-center gap-3 px-3 py-2.5 hover:bg-[var(--color-background-muted)] rounded-lg cursor-pointer transition-colors"
            >
              <div class="relative flex items-center justify-center">
                <input
                  type="checkbox"
                  [checked]="isRoleSelected(role.id)"
                  [id]="'role-' + role.id"
                  class="h-5 w-5 rounded border-2 border-[var(--color-border)] text-[var(--color-brand)] focus:ring-2 focus:ring-[var(--color-brand)]/20 cursor-pointer"
                  (click)="$event.stopPropagation()"
                  (change)="toggleRoleSelection(role.id)"
                />
              </div>
              <label [for]="'role-' + role.id" class="flex-1 cursor-pointer select-none">
                <div class="font-medium text-[var(--color-text)]">{{ role.name }}</div>
                <div *ngIf="role.isSuperAdmin" class="text-xs text-[var(--color-accent)] mt-0.5">Super Admin Role</div>
                <div *ngIf="role.isDefaultRole && !role.isSuperAdmin" class="text-xs text-[var(--color-text-muted)] mt-0.5">Default Role</div>
              </label>
            </div>
            
            <!-- Empty State -->
            <div *ngIf="roles.length === 0" class="px-3 py-4 text-center text-sm text-[var(--color-text-muted)]">
              No roles available
            </div>
          </div>
        </div>
      </div>
      <p class="mt-2 text-sm text-[var(--color-text-muted)]">
        Select one or more roles for this user
      </p>
    </div>

    <!-- Employee ID -->
    <div>
      <label class="block text-sm font-semibold text-[var(--color-text)] mb-2">
        Employee ID
      </label>
      <input
        type="number"
        formControlName="employeeId"
        placeholder="Enter employee ID (optional)"
        class="w-full px-4 py-2.5 border-2 border-[var(--color-border)] rounded-lg focus:outline-none focus:border-[var(--color-brand)] focus:ring-4 focus:ring-[var(--color-brand)]/20 transition-all"
      />
    </div>

    <!-- Extra Employees View (Hidden) -->
    <div class="hidden">
      <label class="block text-sm font-semibold text-[var(--color-text)] mb-2">
        Extra Employees View
      </label>
      <input
        type="text"
        formControlName="extraEmployeesView"
        placeholder="Enter extra employees view (optional)"
        class="w-full px-4 py-2.5 border-2 border-[var(--color-border)] rounded-lg focus:outline-none focus:border-[var(--color-brand)] focus:ring-4 focus:ring-[var(--color-brand)]/20 transition-all"
      />
    </div>

    <!-- LDAP User (Hidden) -->
    <div class="hidden flex items-center gap-2">
      <input
        type="checkbox"
        id="isLdapUser"
        formControlName="isLdapUser"
        class="h-4 w-4 rounded border-2 border-[var(--color-border)] text-[var(--color-brand)] focus:ring-2 focus:ring-[var(--color-brand)]/20"
      />
      <label for="isLdapUser" class="text-sm font-medium text-[var(--color-text)]">
        LDAP User
      </label>
    </div>

    <!-- Error Message -->
    <div *ngIf="errorMessage" class="bg-[var(--color-error)]/10 border border-[var(--color-error)] text-[var(--color-error)] px-4 py-3 rounded-lg">
      {{ errorMessage }}
    </div>

    <!-- Actions -->
    <div class="flex items-center justify-end gap-3 pt-4">
      <app-button
        type="button"
        variant="secondary"
        (click)="close()"
        [disabled]="isLoading"
      >
        Cancel
      </app-button>
      <app-button
        type="submit"
        variant="primary"
        [disabled]="isLoading || userForm.invalid"
      >
        {{ isLoading ? 'Saving...' : (mode === 'create' ? 'Create User' : 'Update User') }}
      </app-button>
    </div>
  </form>
</app-modal>
